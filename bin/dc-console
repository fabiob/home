#!/bin/bash
set -e
set -o pipefail

c="$1"
DC_CMD="docker-cloud"

if [[ -z $c ]]; then
	echo "Usage: $(basename $0) <container or service> [command]"
	exit 1
fi

if [[ ! $c =~ -[0-9]+$ ]]; then
	# if a service name is specified, select a random running container to exec
	row=$($DC_CMD container ps --service "$c" -s Running | tail -n+2 | shuf -n1)
	c=$(echo $row | cut -f2 -d' ')
	name=$(echo $row | cut -f1 -d' ')
	stack=$(echo $row | egrep -o '\S+$')
	echo "Using container: ${name}.${stack}" 1>&2
fi

shift
args="$@"
if [[ -z $args ]]; then
	args="sh"
fi
cols=$(tput cols)
$DC_CMD exec $c sh -c "TERM=xterm COLUMNS=$cols $args"
