#!/bin/sh
set -e
set -x

while [[ $# > 0 ]]; do
  v="$1"
  case "$v" in
    '-a')
      app=$2
      shift
      ;;
    *)
      cmd="${cmd}${v} "
      ;;
  esac
  shift
done

cmd="${cmd:-sh}"

profile=$DEIS_PROFILE
url=$(underscore --outfmt text extract controller < ~/.deis/${profile}.json)
token=$(underscore --outfmt text extract token < ~/.deis/${profile}.json)

json=$(curl -s -H "Authorization: token $token" $url/v1/apps/${app}/containers)

version=$(echo $json | underscore extract --outfmt text 'results.0.release')

exec ssh -t core@$DEISCTL_TUNNEL "docker run -it --rm \$(etcdctl get deis/registry/host):\$(etcdctl get deis/registry/port)/${app}:${version} ${cmd} $@"
