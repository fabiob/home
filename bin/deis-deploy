#!/bin/bash

set -e

remote='deis-production'
app=$(basename `pwd`)
branch='master'

function usage() {
  cat <<USAGE
Uso: $0 [-a APP] [-r REMOTE] [-b BRANCH] [-t TITULO] <descricao>

  <descricao>           A descrição do deploy. Normalmente é o motivo da instalação.
  -a, --app     APP     O nome do aplicativo a instalar (padrão: $app).
  -r, --remote  REMOTE  O remote do GIT para onde fazer o push (padrão: $remote).
  -b, --branch  BRANCH  O branch a fazer push (padrão: $branch).
  -t, --title   TITULO  O título do deploy. Normalmente é um número de versão.
  -l, --list            Lista os deploys realizados.
  -h, --help            Exibe esta tela.
USAGE
  exit $1
}

function erro() {
  echo "$@" > /dev/stderr
  exit 1
}

[[ $# == 0 ]] && usage

desc=()

while (( $# > 0 )); do
  case "$1" in
    -h|--help)
      usage
      ;;
    -l|--list)
      list=1
      ;;
    -a|--app)
      app="$2"
      shift
      ;;
    -t|--title)
      title="$2"
      shift
      ;;
    -r|--remote)
      remote="$2"
      shift
      ;;
    -b|--branch)
      branch="$2"
      shift
      ;;
    *)
      desc=( "${desc[@]}" "$1" )
      ;;
  esac

  shift
done

if [[ ! -z "$list" ]]; then
  echo "Não implementado"
  exit 1
fi

if [[ ${#desc[@]} == 0 ]]; then
  echo "ERRO: é obrigatório informar a descrição do deploy" > /dev/stderr
  usage 1
fi

if [[ -z "$title" ]]; then
  last=`deis releases -a "$app" | head -n2 | tail -n1 | cut -f1 -d' '`
  title="${app}_v$(( ${last#v} + 1 ))"
  if [[ -z $title ]]; then
    echo "ERRO: Não foi possível deduzir o título do deploy, use a opção -t" > /dev/stderr
    usage 1
  fi
fi

echo "Utilizando:"
echo "APP........: ${app}"
echo "REMOTE.....: ${remote}"
echo "BRANCH.....: ${branch}"
echo "TITLE......: ${title}"
echo "DESCRIPTION: ${desc[@]}"
echo
echo "!! AVISO: lembre de pausar as filas do Sidekiq antes de proceder com o deploy !!"
echo
read -p "Pressione ENTER para continuar, ou ^C para cancelar."

id=$( curl --fail -s -XPOST -u "${LIBRATO_USER}:${LIBRATO_TOKEN}" \
           "https://metrics-api.librato.com/v1/annotations/deployments" \
           -d "title=`printf '%q ' "$title"`" \
           -d "description=`printf '%q ' "${desc[@]}"`" \
           -d "start_time=`date +%s`" | tee /dev/stderr | \
      underscore extract --outfmt text 'id' ) || erro "Erro ao informar o deployment ao Librato"

#deis console rails r "puts Sidekiq::ProcessSet.new.select {|p| p.tag == '$sidekiq' }.map(&:quiet!).count" -a "$app" || \
#  erro "Erro ao parar as filas do Sidekiq"

git push "$remote" "$branch"

curl --fail -s -XPUT -u "${LIBRATO_USER}:${LIBRATO_TOKEN}" \
     "https://metrics-api.librato.com/v1/annotations/deployments/${id}" \
     -d "end_time=`date +%s`" || erro "Erro ao finalizar o deployment no Librato"